---
description: 主要包含CAP理论、ACID理论、BASE理论
---

# 分布式系统基本概念

分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此仅仅通过消息传递进行通信和协调的系统。

### 1. CAP理论

一个分布式系统，不可能同时满足**一致性**（consistency）、**可用性**（availability）、**分区容错性**（partition tolerance）这三个基本需求。

#### 1.1 一致性（C）

* **一致性**（Consistency）：**all nodes see the same data at the same time**

  当一个系统**在数据一致的状态下执行更新操作后**，应该保证系统的数据**依然处于一致的状态**。

  > 如果第一个节点对数据进行了更新操作并且更新成功，但是没有让第二个节点上的数据获得相应的更新，这时，第二个节点对数据进行读取的时候，读取到的依然是老数据（脏数据），这就是典型的分布式数据不一致的情况。
  >
  > 在分布式系统中，如果能够做到**针对一个数据项的更新操作执行成功后，所有的用户都可以读取到最新的值**，那么这样的系统就被认为具有强一致性（严格一致性）

#### 1.2 可用性（A）

* **可用性**（Availability）：**Reads and writes always succeed**

  系统所提供的服务必须一直处于可用的状态，对于用户的每个操作请求，总是能够在**有限的时间内返回结果**。

  > **有限的时间**：对于用户的一个操作请求，系统必须能够在指定的时间内返回对应的处理结果，如果超过这个时间范围，那么系统就被认为是不可用的。
  >
  > **返回结果**：要求系统在完成对用户请求的处理之后，返回一个正常的响应结果。正常的响应结果通常**能够明确反映出对请求的处理结果**，即成功或失败，而不是一个模棱两可的结果。

#### 1.3 分区容忍性（P）

* **分区容忍性**（Partition Tolerance）：**the system continues to operate despite arbitrary message loss or failure of part of the system**

  系统在遇到任何**网络分区故障**时，仍然要能够保证对外提供满足一致性和可用性的服务，除非整个网络环境都发生了故障。

  > **网络分区故障**：在分布式系统中，不同的节点分步骤在不同的子网络中，由于一些特殊的原因导致这些**子网络之间出现网络不连通的状况**，但是每个子网络的内部网络是正常的。

#### 1.4 CAP不可能三角

**CAP 不可能三角**：对于一个分布式系统而言，CAP三个特性只能选择2个。

一个分布式系统不可能同时满足CAP三个特性，但是对于分布式系统而言，**分区容忍性（P）是需要保证的最基本的需求**。因为既然是一个分布式的系统，它的组件必然需要被部署到不同的节点，否则分布式也就无从谈起，但是这样就必然会出现子网络。

**通常情况下，如果分布式系统处于正常运行的状态下，CAP三个特性是可以同时保证的，也就是不需要保证分区容忍性，CA特性可以同时满足。但是，一旦出现了分区故障，首先需要保证P，然后才是考虑C还是A。**

* **放弃C（一致性）**：这里所说的放弃一致性并不是完全不需要数据的一致性，而指的是**放弃数据的强一致性，保留数据的最终一致性**，系统无法保证数据保持实时的一致性，但是能够承诺的是，数据最终会达到一个一致的状态，这就引入一个时间窗口的概念，但是具体多久能达到一致需要取决于系统的设计。
* **放弃A（可用性）**：一旦系统遇到网络分区或者其他故障时，那么受到影响的服务需要等待一定的时间，因此在**等待期间系统无法对外提供正常的服务**，即不可用。
* **放弃P（分区容错性）**：与放弃可用性不同，一种简单的做法是**将所有的数据都放在一个节点上**，这样虽然无法保证100%的系统不会出错，但是至少不会碰到由于网络分区带来的影响，但是同时需要注意的是，**放弃P也就意味着放弃了系统的可扩展性**。

### 2. 事务的ACID特性

**事务**（Transaction）具有四个特征，分别为原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）

> **事务**：指的是数据库事务，是数据库管理系统（DBMS）中**执行过程的一个逻辑单位**，一个事务由一个有限的数据库**操作序列**构成。

#### 2.1 原子性（A）

* **原子性（Atomicity）**：任何一项操作失败都将会导致整个事务失败，同时其他已经被执行的操作都将被撤销并回滚，**只有所有的操作全部成功，整个事务才算是完全完成**。

  > 也就是说，事务必须是一个原子的**操作序列单元**，事务中包含的各项操作在一次执行过程中，只允许出现以下两种状态之一：
  >
  > * 全部成功执行
  > * 全部不执行

#### 2.2 一致性（C）

* **一致性（Consistency）**：事务的执行不能破坏数据库数据的完整性和一致性，一个事务在执行之前和执行之后，数据库都必须处于一致性状态。

  > 也就是说，**事务执行的结果必须是使数据库从一个一致性状态转移到另一个一致性状态**。如果数据库系统在运行过程中发生故障，有些事务尚未完成就被迫中断，这些未完成的事务对数据库所做的修改有一部分已经写入数据库，这时数据库就处于一种不正确的状态（不一致的状态）。

#### 2.3 隔离性（I）

* **隔离性（Isolation）**：在并发环境中，并发的事务是互相隔离的，一个事务的执行不能被其他事务干扰.

  > 也就是说，不同的事务**并发操作相同的数据时**，每个事务都有**各自完整的数据空间**。一个事务内部的操作以及使用的数据对其他并发事务是隔离的，并发执行的各个事务之间不能相互干扰。

#### 2.4 持久性（D）

* **持久性（Durability）**：一个事务一旦提交，**它对数据库中对应数据的状态变更就应该是永久性的**。

  > 也就是说，一旦某个事务成功结束，那么它对数据库所做的更新就必须被永久保存下来，即使发生故障，只要数据库能够重新启动，就一定能够将其恢复到事务成功结束时的状态。

### 3. BASE理论

BASE是basically available（基本可用）、soft state（软状态）、eventually consistent（最终一致性）三个短语的缩写。

BASE是对CAP中一致性（C）和可用性（A）权衡的结果。

#### 3.1 基本可用（BA）

* **基本可用（basically available）**：分布式系统在出现不可预知的故障时，**允许损失一部分可用性**（但绝不等价于系统不可用），保证核心可用。

  > 下面是两个基本可用的例子：
  >
  > * **响应时间的损失**：正常情况下一个搜索引擎需要在0.5秒之内返回给用户查询的结果，但是由于出现故障，查询时间增加到了1~2秒。
  > * **功能上的损失**：正常情况下，在一个电商平台上的购物高峰期，为了保护购物系统的稳定性，部分消费者被引导到一个降级的页面。

实现基本可用的方案：

1. **流量削峰**

   将本该在同一时段内发生的流量分散到其他多个时段

2. **延迟响应**

   如果请求的量超过了处理能力，将请求放进队列中，进行排队处理

3. **体验降级**

   在请求量较大的情况下用较低的体验替换较高的。例如将大图片替换成小图片

4. **过载保护**

   将请求放进队列中，如果等待超时，直接拒绝超时的请求，如果队列已满，则清除队列中一定的资源

#### 3.2 软状态（S）

* **软状态（soft state）**：也称为弱状态，**允许系统中的数据存在中间状态**，并且中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程中存在延时。

#### 3.3 最终一致性（E）

* **最终一致性（eventually consistent）**：系统中的所有数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态，因此最终一致性的本质是需要系统保证**最终数据能够达到一致**，**不需要实时保证系统数据的强一致性**。

实现最终一致性的方案：

1. **读时修复**

   读取数据时，检测数据在不同副本上不一致的时候自动修复数据

2. **写时修复**

   写入数据时，检测到数据不一致时，进行修复。如果写入失败，就将数据缓存下来，定期重传，以修复数据不一致的问题

3. **异步修复**

   通过定时对账的方式检测副本中数据的一致性问题，并对其进行修复

### 4. 总结

ACID和BASE实际上是对CAP三个特性的不同取舍。

总的来说，**BASE理论面向的是大型的高可用可扩展的分布式系统**，和传统事务的ACID特性是相反的，它**完全不同于ACID的强一致性模型**，而是**提出通过牺牲强一致性来获得可用性**，并允许数据在一段时间内是不一致的，但是最终需要达到一致状态。

